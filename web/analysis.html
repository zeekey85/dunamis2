<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dunamis - Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
       <header class="text-center mb-8">
            <img src="/assets/logo.png" alt="Logo" class="w-20 h-20 mx-auto mb-4 rounded-full">
            <h1 class="text-4xl font-bold text-gray-900">Workout Analysis</h1>
            <p id="current-user-display" class="text-gray-600 mt-2">Loading user...</p>
            <div class="mt-4 flex justify-center items-center gap-4 flex-wrap">
                <a href="index.html" class="text-blue-600 hover:underline">Planner</a>
                <a href="Workout.html" class="text-blue-600 hover:underline">Tracker</a>
                <a href="analysis.html" class="text-blue-600 hover:underline">Analysis</a>
                <a href="Users.html" class="text-blue-600 hover:underline">Manage Athletes</a>
                <a href="/logout" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Logout</a>
            </div>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-lg border mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 text-center">Performance Charts</h2>
            <div id="user-selector-container" class="text-center mb-4 hidden">
                 <label for="coach-user-selector" class="block text-sm font-medium text-gray-700">View Analysis for:</label>
                <select id="coach-user-selector" class="mt-1 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full sm:w-1/3"></select>
            </div>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <select id="exercise-selector" class="px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full sm:w-auto" disabled>
                    <option value="">-- Select an Exercise --</option>
                </select>
            </div>
            <p id="statusMessage" class="text-sm text-center font-medium h-5 mt-4"></p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <canvas id="maxWeightChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <canvas id="totalVolumeChart"></canvas>
            </div>
        </div>

        <div class="mt-8 bg-white p-6 rounded-xl shadow-lg border">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 text-center">Workout Logbook</h2>
            <div id="logbook-selector-container" class="text-center mb-4">
                <select id="logbook-workout-selector" class="px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full sm:w-1/2" disabled>
                    <option value="">-- Select an Athlete to View Logs --</option>
                </select>
            </div>
            <div id="workout-details-container" class="mt-4 max-h-96 overflow-y-auto">
                <!-- Details will be rendered here -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const GET_CURRENT_USER_URL = '/api/get_current_user';
        const GET_ATHLETES_URL = '/api/get_athletes';
        const GET_ANALYSIS_URL = '/api/get_analysis';
        const GET_TEMPLATES_URL = '/api/list_templates';
        const GET_WORKOUT_URL = '/api/get_workout';

        // --- DOM ELEMENTS ---
        const currentUserDisplay = document.getElementById('current-user-display');
        const userSelectorContainer = document.getElementById('user-selector-container');
        const coachUserSelector = document.getElementById('coach-user-selector');
        const exerciseSelector = document.getElementById('exercise-selector');
        const statusMessage = document.getElementById('statusMessage');
        const logbookSelector = document.getElementById('logbook-workout-selector');
        const workoutDetailsContainer = document.getElementById('workout-details-container');

        // --- STATE & CHARTS ---
        let currentUser = null;
        let userRole = null;
        let analysisData = {};
        let maxWeightChart = null;
        let totalVolumeChart = null;

        // --- INITIALIZATION ---
        async function initializePage() {
            try {
                const userRes = await fetch(GET_CURRENT_USER_URL);
                if (!userRes.ok) throw new Error(`Failed to fetch user data: ${userRes.statusText}`);
                const userData = await userRes.json();
                currentUser = userData.username;
                userRole = userData.role;
                currentUserDisplay.textContent = `Logged in as: ${currentUser} (${userRole})`;

                if (userRole === 'coach') {
                    await setupCoachView();
                } else {
                    await loadAnalysisForUser(currentUser);
                    await populateLogbookSelector(currentUser);
                }
            } catch(e) {
                console.error("Initialization failed", e);
                currentUserDisplay.textContent = "Error: Could not load user data.";
            }
        }

        // --- COACH VIEW ---
        async function setupCoachView() {
            userSelectorContainer.classList.remove('hidden');
             try {
                const response = await fetch(GET_ATHLETES_URL);
                if (!response.ok) throw new Error('Failed to fetch athlete list');
                const data = await response.json();

                if (data.status === 'success' && data.athletes.length > 0) {
                    coachUserSelector.innerHTML = '<option value="">-- Select an Athlete --</option>';
                    data.athletes.forEach(athlete => {
                        // FIX: Use athlete.name for the display text and value
                        coachUserSelector.add(new Option(athlete.name, athlete.name));
                    });

                    coachUserSelector.addEventListener('change', () => {
                        const selectedAthlete = coachUserSelector.value;
                        if (maxWeightChart) maxWeightChart.destroy();
                        if (totalVolumeChart) totalVolumeChart.destroy();
                        workoutDetailsContainer.innerHTML = '';
                        
                        if (selectedAthlete) {
                            loadAnalysisForUser(selectedAthlete);
                            populateLogbookSelector(selectedAthlete);
                        } else {
                            exerciseSelector.innerHTML = '<option value="">-- Select Athlete First --</option>';
                            exerciseSelector.disabled = true;
                            logbookSelector.innerHTML = '<option value="">-- Select an Athlete to View Logs --</option>';
                            logbookSelector.disabled = true;
                        }
                    });
                } else {
                     coachUserSelector.innerHTML = '<option value="">-- No Athletes Found --</option>';
                }
            } catch(e) {
                console.error(e);
                coachUserSelector.innerHTML = '<option value="">-- Error Loading Athletes --</option>';
            }
        }
        
        // --- DATA & CHARTING ---
        async function loadAnalysisForUser(user) {
            statusMessage.textContent = 'Loading analysis...';
            statusMessage.className = 'text-blue-500 text-sm font-medium h-5 mt-4 text-center';
            try {
                const response = await fetch(`${GET_ANALYSIS_URL}?user=${user}`);
                if (!response.ok) throw new Error('Failed to fetch analysis data');
                const data = await response.json();
                if (data.status !== 'success') throw new Error(data.message || 'Analysis failed');
                analysisData = data.analysis;
                populateExerciseSelector();
                statusMessage.textContent = 'Select an exercise to view its progression.';
            } catch (e) {
                console.error(e);
                statusMessage.textContent = `Error: ${e.message}`;
                statusMessage.className = 'text-red-500 text-sm font-medium h-5 mt-4 text-center';
            }
        }

        function populateExerciseSelector() {
            const exercises = Object.keys(analysisData);
            exerciseSelector.innerHTML = '<option value="">-- Select an Exercise --</option>';
            if (exercises.length > 0) {
                exercises.sort().forEach(ex => exerciseSelector.add(new Option(ex, ex)));
                exerciseSelector.disabled = false;
            } else {
                exerciseSelector.innerHTML = '<option value="">-- No Data to Analyze --</option>';
                exerciseSelector.disabled = true;
            }
        }
        
        function updateCharts() {
            const selectedExercise = exerciseSelector.value;
            if (maxWeightChart) maxWeightChart.destroy();
            if (totalVolumeChart) totalVolumeChart.destroy();
            if (!selectedExercise || !analysisData[selectedExercise]) return;
            const exerciseData = analysisData[selectedExercise];
            const labels = exerciseData.date.map(d => new Date(d).toLocaleDateString());
            maxWeightChart = new Chart(document.getElementById('maxWeightChart'), { type: 'line', data: { labels, datasets: [{ label: 'Max Weight Lifted (lb)', data: exerciseData.max_weight, borderColor: 'rgb(59, 130, 246)', tension: 0.1 }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Max Weight Progression' }}}});
            totalVolumeChart = new Chart(document.getElementById('totalVolumeChart'), { type: 'bar', data: { labels, datasets: [{ label: 'Total Volume (reps * weight)', data: exerciseData.total_volume, backgroundColor: 'rgb(34, 197, 94)' }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Total Volume Progression' }}}});
        }

        // --- LOGBOOK FUNCTIONS ---
        async function populateLogbookSelector(user) {
            logbookSelector.disabled = true;
            logbookSelector.innerHTML = '<option value="">-- Loading Logs... --</option>';
            try {
                const response = await fetch(`${GET_TEMPLATES_URL}?user=${user}`);
                const data = await response.json();
                if (data.status === 'success' && data.templates.length > 0) {
                    logbookSelector.innerHTML = '<option value="">-- Select a Completed Workout --</option>';
                    data.templates.forEach(workout => {
                        const name = workout.filename.replace('_tracked.csv', '').replace(/_/g, ' ');
                        logbookSelector.add(new Option(name, `finished:${workout.filename}`));
                    });
                    logbookSelector.disabled = false;
                } else {
                    logbookSelector.innerHTML = '<option value="">-- No Completed Workouts Found --</option>';
                }
            } catch (e) {
                console.error(e);
                logbookSelector.innerHTML = '<option value="">-- Error Loading Logs --</option>';
            }
        }

        async function loadWorkoutDetails(selection) {
            if (!selection) {
                workoutDetailsContainer.innerHTML = '';
                return;
            }
            const [type, filename] = selection.split(':', 2);
            workoutDetailsContainer.innerHTML = '<p>Loading workout details...</p>';
            try {
                const response = await fetch(`${GET_WORKOUT_URL}?type=${type}&filename=${filename}`);
                if (!response.ok) throw new Error('Could not fetch workout file');
                const csvText = await response.text();
                renderWorkoutDetailsTable(csvText);
            } catch(e) {
                console.error(e);
                workoutDetailsContainer.innerHTML = `<p class="text-red-500">${e.message}</p>`;
            }
        }

        function renderWorkoutDetailsTable(csvText) {
            const rows = csvText.trim().split('\n');
            const headers = rows[0].split(',');
            let tableHtml = '<table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>';
            headers.forEach(h => tableHtml += `<th scope="col" class="px-4 py-2">${h.replace(/"/g, '')}</th>`);
            tableHtml += '</tr></thead><tbody>';
            rows.slice(1).forEach(row => {
                tableHtml += '<tr class="bg-white border-b">';
                row.split(',').forEach(cell => tableHtml += `<td class="px-4 py-2">${cell.replace(/"/g, '')}</td>`);
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            workoutDetailsContainer.innerHTML = tableHtml;
        }

        // --- EVENT LISTENERS ---
        exerciseSelector.addEventListener('change', updateCharts);
        logbookSelector.addEventListener('change', (e) => loadWorkoutDetails(e.target.value));

        // --- INITIALIZATION ---
        initializePage();
    </script>
</body>
</html>

